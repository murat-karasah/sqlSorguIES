
SELECT
ROW_NUMBER() OVER(ORDER BY CITY ASC) AS ROWNR,
CITY,MONTH(CLL.DATE_) AS MONTH,
CLL.AMOUNT AS AMOUNT,
SUM(AMOUNT) OVER (PARTITION BY CITY ORDER BY MONTH(CLL.DATE_) rows between unbounded preceding and current row ) AS CUMULATIVE_TOTAL_BY_CITY_MONTH,
SUM(AMOUNT) OVER (PARTITION BY CITY) AS CITY_TOTAL,
SUM(AMOUNT) OVER () AS OVERAL_TOTAL,
CONVERT(decimal(5,2), (CLL.AMOUNT*100 / SUM(AMOUNT) OVER (PARTITION BY CITY))) AS  CITY_OVERAL_RATIO,
CONVERT(decimal(5,2), (SUM(AMOUNT) OVER (PARTITION BY CITY) *100/ SUM(AMOUNT) OVER ())) AS  RATIO,
CONVERT(decimal(5,2), (SUM(AMOUNT) OVER (PARTITION BY CITY  ORDER BY CITY  ) *100/ SUM(AMOUNT) OVER ())) AS  CITY_RATIO

 



FROM LG_115_01_CLFLINE as CLL
INNER JOIN LG_115_CLCARD as CLC
on CLL.LOGICALREF = CLC.LOGICALREF

WHERE  CITY IS NOT NULL AND CITY != '' AND CITY NOT LIKE '%Ä°STANBUL%' 
